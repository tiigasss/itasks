<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Tarefa - Itasks</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>ğŸš€ Nova Tarefa</h1>
            <div class="user-info">
                <span id="userName"></span>
                <button class="logout-btn" onclick="goBack()">â† Voltar</button>
            </div>
        </header>

        <div class="form-container">
            <form id="taskForm" class="task-form">
                <div class="form-group">
                    <label for="title">ğŸ“‹ TÃ­tulo da Tarefa *</label>
                    <input type="text" id="title" name="title" required placeholder="Ex: Corrigir Bug no Login">
                </div>

                <div class="form-group">
                    <label for="description">ğŸ“ DescriÃ§Ã£o</label>
                    <textarea id="description" name="description" rows="4" placeholder="Detalhes tÃ©cnicos..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="type_id">ğŸ·ï¸ Tipo de Tarefa *</label>
                        <select id="type_id" name="type_id" required>
                            </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="story_points">ğŸ“Š Story Points</label>
                        <select id="story_points" name="story_points">
                            <option value="1">1 - Muito Pequena</option>
                            <option value="3">3 - MÃ©dia</option>
                            <option value="5">5 - Grande</option>
                            <option value="8">8 - Muito Grande</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="programmer_id">ğŸ‘¤ Programador (Executante) *</label>
                        <select id="programmer_id" name="programmer_id" required>
                            <option value="">Selecione...</option>
                            </select>
                    </div>

                    <div class="form-group">
                        <label for="order">ğŸ”¢ Ordem</label>
                        <input type="number" id="order" name="order" value="1" min="1">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="predicted_start_date">ğŸ“… Prev. InÃ­cio *</label>
                        <input type="date" id="predicted_start_date" name="predicted_start_date" required>
                    </div>

                    <div class="form-group">
                        <label for="predicted_end_date">ğŸ“… Prev. Fim *</label>
                        <input type="date" id="predicted_end_date" name="predicted_end_date" required>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="goBack()">Cancelar</button>
                    <button type="submit" class="btn-primary">Criar Tarefa</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentUser = null;

        // 1. Verificar Login e PermissÃ£o
        function checkAuth() {
            currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('userName').textContent = `ğŸ‘‹ ${currentUser.name}`;
            
            // SÃ³ Gestor pode criar tarefas
            if (currentUser.type !== 'Gestor') {
                alert('PermissÃ£o negada: Apenas Gestores criam tarefas.');
                window.location.href = 'kanban.html';
            }
        }

        // 2. Carregar Programadores (com NÃ­vel de XP)
        async function loadProgrammers() {
            try {
                const res = await fetch(`${API_BASE}/programmers`);
                const progs = await res.json();
                const select = document.getElementById('programmer_id');
                
                progs.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    // Mostra o nÃ­vel de experiÃªncia no dropdown (requisito implÃ­cito do UML)
                    opt.textContent = `${p.name} (${p.experience_level || 'N/A'})`;
                    select.appendChild(opt);
                });
            } catch (err) { console.error(err); }
        }

        // 3. Carregar Tipos de Tarefa
        async function loadTaskTypes() {
            try {
                const res = await fetch(`${API_BASE}/task-types`);
                const types = await res.json();
                const select = document.getElementById('type_id');
                
                types.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.textContent = t.name;
                    select.appendChild(opt);
                });
            } catch (err) { console.error(err); }
        }

        // 4. Enviar FormulÃ¡rio
        document.getElementById('taskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            const taskData = {
                title: formData.get('title'),
                description: formData.get('description'),
                type_id: parseInt(formData.get('type_id')),
                story_points: parseInt(formData.get('story_points')),
                programmer_id: parseInt(formData.get('programmer_id')),
                order_num: parseInt(formData.get('order')),
                predicted_start_date: formData.get('predicted_start_date'),
                predicted_end_date: formData.get('predicted_end_date'),
                
                // CRUCIAL: Envia o ID do Gestor logado como criador
                manager_id: currentUser.id 
            };

            try {
                const res = await fetch(`${API_BASE}/tasks`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(taskData)
                });
                const result = await res.json();
                if(result.success) {
                    alert('Tarefa criada!');
                    window.location.href = 'kanban.html';
                } else {
                    alert('Erro: ' + result.message);
                }
            } catch (err) { alert('Erro de conexÃ£o.'); }
        });

        function goBack() { window.location.href = 'kanban.html'; }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadProgrammers();
            loadTaskTypes();
        });
    </script>
</body>
</html>